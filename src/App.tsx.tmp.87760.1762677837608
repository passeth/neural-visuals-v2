import { useState, useEffect } from 'react';
import { Canvas } from '@react-three/fiber';
import { OrbitControls } from '@react-three/drei';
import { ControlPanel } from './components/ControlPanel';
import { MoonlightParticles } from './themes/MoonlightParticles';
import { OceanWaves } from './themes/OceanWaves';
import { MentalFocus } from './themes/MentalFocus';
import { ZenFocus } from './themes/ZenFocus';
import { BrainBoost } from './themes/BrainBoost';
import { CreativeFlow } from './themes/CreativeFlow';
import { useAudioSystem } from './hooks/useAudioSystem';
import { useVideoRecorder } from './hooks/useVideoRecorder';
import type { VisualParams, Theme, AudioData } from './types';

const themes: Theme[] = [
  {
    id: 'mentalfocus',
    name: 'âš¡ Mental Focus',
    description: 'Sharp angular cuts, aggressive particle streams, intense concentration energy'
  },
  {
    id: 'zenfocus',
    name: 'ðŸ§˜ Zen Focus',
    description: 'Smooth flowing waves, calm elegant curves, meditative gentle motion'
  },
  {
    id: 'brainboost',
    name: 'ðŸš€ Brain Boost',
    description: 'Electric arcing paths, energetic swirls, dynamic explosive movement'
  },
  {
    id: 'creativeflow',
    name: 'ðŸŽ¨ Creative Flow',
    description: 'Organic flowing streams, playful color shifts, imaginative patterns'
  },
  {
    id: 'moonlight',
    name: 'ðŸŒ™ Moonlight',
    description: 'Flowing 3D particle mesh with wave distortion depicting moonlight rays'
  },
  {
    id: 'ocean',
    name: 'ðŸŒŠ Ocean Waves',
    description: 'Tranquil ocean surface with moonlight sparkles (ìœ¤ìŠ¬)'
  },
];

function App() {
  const [currentTheme, setCurrentTheme] = useState<string>('mentalfocus');
  const [params, setParams] = useState<VisualParams>({
    speed: 1.0,
    density: 0.5,
    audioReactivity: 0.6,
  });

  const audioSystem = useAudioSystem();
  const [audioData, setAudioData] = useState<AudioData | null>(null);
  const videoRecorder = useVideoRecorder(audioSystem.audioElementRef);

  // Update audio data continuously
  useEffect(() => {
    const interval = setInterval(() => {
      const data = audioSystem.getAudioData();
      setAudioData(data);
    }, 50); // 20fps

    return () => clearInterval(interval);
  }, [audioSystem]);

  const renderTheme = () => {
    switch (currentTheme) {
      case 'mentalfocus':
        return <MentalFocus audioData={audioData} params={params} />;
      case 'zenfocus':
        return <ZenFocus audioData={audioData} params={params} />;
      case 'brainboost':
        return <BrainBoost audioData={audioData} params={params} />;
      case 'creativeflow':
        return <CreativeFlow audioData={audioData} params={params} />;
      case 'moonlight':
        return <MoonlightParticles audioData={audioData} params={params} />;
      case 'ocean':
        return <OceanWaves audioData={audioData} params={params} />;
      default:
        return <MentalFocus audioData={audioData} params={params} />;
    }
  };

  return (
    <>
      <Canvas
        camera={{ position: [0, 0, 30], fov: 75 }}
        gl={{ antialias: true, alpha: true }}
      >
        <color attach="background" args={['#000000']} />

        {/* Ambient light for subtle glow */}
        <ambientLight intensity={0.2} />

        {/* Theme-specific lighting */}
        {currentTheme === 'mentalfocus' && (
          <>
            <pointLight position={[0, 0, 0]} intensity={1.5} color="#00e6ff" />
            <pointLight position={[20, 10, 10]} intensity={0.8} color="#0080ff" />
          </>
        )}
        {currentTheme === 'zenfocus' && (
          <>
            <pointLight position={[0, 15, 10]} intensity={0.9} color="#80ccd9" />
            <pointLight position={[0, -10, -10]} intensity={0.6} color="#4d99a6" />
          </>
        )}
        {currentTheme === 'brainboost' && (
          <>
            <pointLight position={[0, 0, 0]} intensity={1.8} color="#ff4db3" />
            <pointLight position={[20, 15, 10]} intensity={1.2} color="#9933e6" />
            <pointLight position={[-20, -15, -10]} intensity={0.9} color="#ffe633" />
          </>
        )}
        {currentTheme === 'creativeflow' && (
          <>
            <pointLight position={[15, 10, 10]} intensity={1.0} color="#f280b3" />
            <pointLight position={[-15, -10, -10]} intensity={0.8} color="#66d999" />
            <pointLight position={[0, 15, 0]} intensity={0.7} color="#ffd94d" />
          </>
        )}
        {currentTheme === 'moonlight' && (
          <pointLight position={[0, 0, 0]} intensity={1} color="#a0c4ff" />
        )}
        {currentTheme === 'ocean' && (
          <>
            <pointLight position={[0, 10, 10]} intensity={1} color="#b3bfd9" />
            <pointLight position={[0, -5, -10]} intensity={0.5} color="#264066" />
          </>
        )}

        {renderTheme()}

        {/* Allow user to rotate view */}
        <OrbitControls
          enableZoom={true}
          enablePan={false}
          minDistance={20}
          maxDistance={50}
          autoRotate={false}
        />
      </Canvas>

      <ControlPanel
        themes={themes}
        currentTheme={currentTheme}
        setCurrentTheme={setCurrentTheme}
        params={params}
        setParams={setParams}
        audioSystem={{
          isPlaying: audioSystem.isPlaying,
          audioFile: audioSystem.audioFile,
          currentTime: audioSystem.currentTime,
          duration: audioSystem.duration,
          audioError: audioSystem.audioError,
          volume: audioSystem.volume,
          setVolume: audioSystem.setVolume,
          loadAudioFile: audioSystem.loadAudioFile,
          togglePlayPause: audioSystem.togglePlayPause,
        }}
        videoRecorder={{
          isRecording: videoRecorder.isRecording,
          recordedBlob: videoRecorder.recordedBlob,
          recordingDuration: videoRecorder.recordingDuration,
          error: videoRecorder.error,
          isAutoGenerating: videoRecorder.isAutoGenerating,
          autoProgress: videoRecorder.autoProgress,
          startRecording: videoRecorder.startRecording,
          stopRecording: videoRecorder.stopRecording,
          downloadRecording: videoRecorder.downloadRecording,
          clearRecording: videoRecorder.clearRecording,
          autoGenerateVideo: videoRecorder.autoGenerateVideo,
          cancelAutoGeneration: videoRecorder.cancelAutoGeneration,
        }}
      />

      <div className="dedication">
        Neural Visuals v2 - Binaural Beats Visualization
      </div>
    </>
  );
}

export default App;
