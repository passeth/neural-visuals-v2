import React from 'react';
import type { VisualParams, Theme } from '../types';

interface AudioSystemProps {
  isPlaying: boolean;
  audioFile: string | null;
  currentTime: number;
  duration: number;
  audioError: string;
  volume: number;
  setVolume: (volume: number) => void;
  loadAudioFile: (file: File) => void;
  loadPresetAudio: (url: string, fileName: string) => void;
  togglePlayPause: () => void;
}

interface VideoRecorderProps {
  isRecording: boolean;
  recordedBlob: Blob | null;
  recordingDuration: number;
  error: string;
  isAutoGenerating: boolean;
  autoProgress: number;
  startRecording: () => void;
  stopRecording: () => void;
  downloadRecording: () => void;
  clearRecording: () => void;
  autoGenerateVideo: (duration: number) => void;
  cancelAutoGeneration: () => void;
}

interface ControlPanelProps {
  themes: Theme[];
  currentTheme: string;
  setCurrentTheme: (theme: string) => void;
  params: VisualParams;
  setParams: (params: VisualParams) => void;
  audioSystem: AudioSystemProps;
  videoRecorder: VideoRecorderProps;
}

export const ControlPanel: React.FC<ControlPanelProps> = ({
  themes,
  currentTheme,
  setCurrentTheme,
  params,
  setParams,
  audioSystem,
  videoRecorder
}) => {
  const handleParamChange = (key: keyof VisualParams, value: number | string) => {
    setParams({ ...params, [key]: value });
  };

  const presetAudioFiles = [
    { id: 'digital-library', name: 'üìö Digital Library Flow', file: 'Digital_Library_Flow_2025-11-08T065537.wav' },
    { id: 'cortex-focus', name: 'üß† Effective Cortex Focus', file: 'Effective Cortex Focus.mp3' },
    { id: 'lubelly', name: 'üéµ Lubelly', file: 'lubelly_ rec0FBbVb3apProR6.mp3' },
    { id: 'night-comfort', name: 'üåô Night Comfort Delta Sleep', file: 'Night_Comfort_Deep_Delta_Binaural_Sleep_2025-11-08T070127.wav' },
    { id: 'primordial-cradle', name: 'üåä Primordial Cradle', file: 'Primordial Cradle.mp3' },
    { id: 'return-origin', name: '‚ú® Return to Origin', file: 'Return to Origin.mp3' },
  ];

  const oceanColorPresets = [
    { id: 'midnight', name: 'üåô Midnight Ocean' },
    { id: 'tropical', name: 'üèùÔ∏è Tropical Paradise' },
    { id: 'sunset', name: 'üåÖ Sunset Glow' },
    { id: 'arctic', name: 'üßä Arctic Ice' },
    { id: 'emerald', name: 'üíé Emerald Deep' },
  ];

  const mentalFocusColorPresets = [
    { id: 'electric', name: '‚ö° Electric Blue' },
    { id: 'softPink', name: 'üå∏ Soft Pink' },
    { id: 'softGreen', name: 'üçÉ Soft Green' },
    { id: 'softYellow', name: '‚òÄÔ∏è Soft Yellow' },
  ];

  const brainBoostColorPresets = [
    { id: 'electric', name: '‚ö° Electric Purple' },
    { id: 'softPink', name: 'üå∏ Soft Pink' },
    { id: 'softGreen', name: 'üçÉ Soft Green' },
    { id: 'softYellow', name: '‚òÄÔ∏è Soft Yellow' },
  ];

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      audioSystem.loadAudioFile(file);
    }
  };

  const formatTime = (time: number) => {
    if (isNaN(time)) return '0:00';
    const mins = Math.floor(time / 60);
    const secs = Math.floor(time % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const formatDuration = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return (
    <div className="control-panel">
      <h3>üé¨ Video Recording</h3>

      <div className="control-group">
        {!videoRecorder.isRecording && !videoRecorder.recordedBlob && !videoRecorder.isAutoGenerating && (
          <>
            <button
              onClick={() => videoRecorder.autoGenerateVideo(audioSystem.duration)}
              className="auto-generate-btn"
              disabled={!audioSystem.audioFile}
              title={!audioSystem.audioFile ? 'Please load audio first' : 'Auto-generate full video'}
            >
              ‚ú® Auto-Generate Video
            </button>
            <button
              onClick={videoRecorder.startRecording}
              className="record-btn"
              disabled={!audioSystem.audioFile}
              title={!audioSystem.audioFile ? 'Please load audio first' : 'Manual recording'}
            >
              ‚è∫ Manual Recording
            </button>
          </>
        )}

        {videoRecorder.isAutoGenerating && (
          <>
            <div className="auto-generating-indicator">
              <div className="progress-bar">
                <div
                  className="progress-fill"
                  style={{ width: `${videoRecorder.autoProgress}%` }}
                />
              </div>
              <div className="progress-text">
                Generating: {Math.round(videoRecorder.autoProgress)}%
              </div>
            </div>
            <button
              onClick={videoRecorder.cancelAutoGeneration}
              className="cancel-btn"
            >
              ‚èπ Cancel
            </button>
          </>
        )}

        {videoRecorder.isRecording && (
          <>
            <button
              onClick={videoRecorder.stopRecording}
              className="stop-btn"
            >
              ‚èπ Stop Recording
            </button>
            <div className="recording-indicator">
              <span className="recording-dot"></span>
              Recording: {formatDuration(videoRecorder.recordingDuration)}
            </div>
          </>
        )}

        {videoRecorder.recordedBlob && (
          <>
            <button
              onClick={videoRecorder.downloadRecording}
              className="download-btn"
            >
              ‚¨áÔ∏è Download Video
            </button>
            <button
              onClick={videoRecorder.clearRecording}
              className="clear-btn"
            >
              üóëÔ∏è Clear
            </button>
            <div className="recorded-info">
              ‚úÖ Video ready ({(videoRecorder.recordedBlob.size / 1024 / 1024).toFixed(2)} MB)
            </div>
          </>
        )}

        {videoRecorder.error && (
          <div className="video-error">‚ùå {videoRecorder.error}</div>
        )}

        {!audioSystem.audioFile && (
          <div className="video-hint">
            üí° Upload audio first to enable recording
          </div>
        )}
      </div>

      <h3>üéµ Audio</h3>

      <div className="control-group">
        <label>Preset Sounds</label>
        <select
          onChange={(e) => {
            const selected = presetAudioFiles.find(p => p.id === e.target.value);
            if (selected) {
              audioSystem.loadPresetAudio(`/audio/${selected.file}`, selected.name);
            }
          }}
          defaultValue=""
        >
          <option value="" disabled>Select a preset...</option>
          {presetAudioFiles.map(preset => (
            <option key={preset.id} value={preset.id}>
              {preset.name}
            </option>
          ))}
        </select>
      </div>

      <div className="control-group">
        <label className="file-upload-btn">
          üìÅ Upload Audio
          <input
            type="file"
            accept="audio/*"
            onChange={handleFileUpload}
            style={{ display: 'none' }}
          />
        </label>

        {audioSystem.audioFile && (
          <>
            <button
              onClick={audioSystem.togglePlayPause}
              className="audio-play-btn"
            >
              {audioSystem.isPlaying ? '‚è∏ Pause' : '‚ñ∂ Play'}
            </button>
            <div className="audio-info">
              <span className="audio-filename">{audioSystem.audioFile}</span>
              <span>
                {formatTime(audioSystem.currentTime)} / {formatTime(audioSystem.duration)}
              </span>
            </div>
          </>
        )}

        {audioSystem.audioError && (
          <div className="audio-error">‚ùå {audioSystem.audioError}</div>
        )}
      </div>

      <div className="control-group">
        <label>Volume: {audioSystem.volume}%</label>
        <input
          type="range"
          min="0"
          max="100"
          value={audioSystem.volume}
          onChange={(e) => audioSystem.setVolume(parseInt(e.target.value))}
        />
      </div>

      <h3>üé® Visual</h3>

      <div className="control-group">
        <label>Theme</label>
        <select
          value={currentTheme}
          onChange={(e) => setCurrentTheme(e.target.value)}
        >
          {themes.map(theme => (
            <option key={theme.id} value={theme.id}>
              {theme.name}
            </option>
          ))}
        </select>
      </div>

      <div className="control-group">
        <label>Speed: {params.speed.toFixed(1)}x</label>
        <input
          type="range"
          min="0.1"
          max="3"
          step="0.1"
          value={params.speed}
          onChange={(e) => handleParamChange('speed', parseFloat(e.target.value))}
        />
      </div>

      <div className="control-group">
        <label>Density: {params.density.toFixed(1)}</label>
        <input
          type="range"
          min="0.1"
          max="1"
          step="0.1"
          value={params.density}
          onChange={(e) => handleParamChange('density', parseFloat(e.target.value))}
        />
      </div>

      <div className="control-group">
        <label>Audio Reactivity: {params.audioReactivity.toFixed(1)}</label>
        <input
          type="range"
          min="0"
          max="1"
          step="0.1"
          value={params.audioReactivity}
          onChange={(e) => handleParamChange('audioReactivity', parseFloat(e.target.value))}
        />
      </div>

      {currentTheme === 'ocean' && (
        <div className="control-group">
          <label>Ocean Color</label>
          <select
            value={params.colorPreset || 'midnight'}
            onChange={(e) => handleParamChange('colorPreset', e.target.value)}
          >
            {oceanColorPresets.map(preset => (
              <option key={preset.id} value={preset.id}>
                {preset.name}
              </option>
            ))}
          </select>
        </div>
      )}

      {currentTheme === 'mentalfocus' && (
        <div className="control-group">
          <label>Mental Focus Color</label>
          <select
            value={params.colorPreset || 'electric'}
            onChange={(e) => handleParamChange('colorPreset', e.target.value)}
          >
            {mentalFocusColorPresets.map(preset => (
              <option key={preset.id} value={preset.id}>
                {preset.name}
              </option>
            ))}
          </select>
        </div>
      )}

      {currentTheme === 'brainboost' && (
        <div className="control-group">
          <label>Brain Boost Color</label>
          <select
            value={params.colorPreset || 'electric'}
            onChange={(e) => handleParamChange('colorPreset', e.target.value)}
          >
            {brainBoostColorPresets.map(preset => (
              <option key={preset.id} value={preset.id}>
                {preset.name}
              </option>
            ))}
          </select>
        </div>
      )}
    </div>
  );
};
